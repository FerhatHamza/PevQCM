<!DOCTYPE html>
<html lang="fr" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QCM Vaccination - PEV Algérie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
        }
        .rtl {
            direction: rtl;
        }
        .ltr {
            direction: ltr;
        }
    </style>
</head>
<body class="bg-gray-50 rtl">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-800 mb-2">اختبار التلقيح - البرنامج الموسع للتلقيح</h1>
            <p class="text-gray-600">QCM Vaccination - Programme Élargi de Vaccination (PEV) Algérie</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex justify-center mb-6 border-b">
            <button id="tab-quiz" class="px-6 py-3 font-medium text-blue-600 border-b-2 border-blue-600">الاختبار</button>
            <button id="tab-admin" class="px-6 py-3 font-medium text-gray-500 hover:text-blue-600">الإدارة</button>
            <button id="tab-stats" class="px-6 py-3 font-medium text-gray-500 hover:text-blue-600">الإحصائيات</button>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-section" class="space-y-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">الاختبار</h2>
                    <div class="flex gap-2">
                        <button id="prev-btn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">السابق</button>
                        <span id="question-counter" class="px-4 py-2">1 / 25</span>
                        <button id="next-btn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">التالي</button>
                    </div>
                </div>
                
                <div id="question-container" class="mb-6">
                    <!-- Question will be loaded here -->
                </div>

                <div id="result-container" class="mt-4 p-4 rounded hidden"></div>

                <div class="flex justify-center mt-6">
                    <button id="submit-answer" class="px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                        تأكيد الإجابة
                    </button>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="admin-section" class="hidden space-y-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">إدارة الأسئلة</h2>
                    <button id="show-add-form" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        إضافة سؤال جديد
                    </button>
                </div>

                <!-- Admin Login Form -->
                <div id="admin-login" class="mb-6">
                    <input type="password" id="admin-password" placeholder="كلمة المرور" class="w-full p-2 border rounded mb-2">
                    <button id="admin-login-btn" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        دخول
                    </button>
                </div>

                <!-- Admin Content (hidden until login) -->
                <div id="admin-content" class="hidden">
                    <!-- Question Form -->
                    <div id="question-form" class="hidden mb-6 p-4 border rounded">
                        <h3 class="font-semibold mb-3">إضافة/تعديل سؤال</h3>
                        <input type="hidden" id="question-id">
                        <div class="mb-3">
                            <label class="block mb-1">السؤال</label>
                            <textarea id="question-text" rows="2" class="w-full p-2 border rounded"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="block mb-1">الخيارات (4 خيارات)</label>
                            <div id="options-container">
                                <!-- Options will be generated here -->
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="block mb-1">رقم الإجابة الصحيحة (0-3)</label>
                            <input type="number" id="correct-index" min="0" max="3" class="w-full p-2 border rounded">
                        </div>
                        <div class="mb-3">
                            <label class="block mb-1">التفسير</label>
                            <textarea id="explanation" rows="2" class="w-full p-2 border rounded"></textarea>
                        </div>
                        <div class="flex gap-2">
                            <button id="save-question" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">حفظ</button>
                            <button id="cancel-form" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">إلغاء</button>
                        </div>
                    </div>

                    <!-- Questions List -->
                    <div id="questions-list" class="space-y-3">
                        <!-- Questions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div id="stats-section" class="hidden space-y-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">الإحصائيات العامة</h2>
                <div id="global-stats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <!-- Global stats will be loaded here -->
                </div>
                
                <h3 class="text-lg font-semibold mb-3">تفاصيل الأسئلة</h3>
                <div id="questions-stats" class="space-y-3">
                    <!-- Questions stats will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://pevqcm-api.ferhathamza17.workers.dev/api';
        let currentQuestions = [];
        let currentIndex = 0;
        let selectedAnswer = null;
        let adminToken = null;
        let isAnswered = false;

        // Load questions on page load
        async function loadQuestions() {
            try {
                const response = await fetch(`${API_BASE}/questions`);
                currentQuestions = await response.json();
                if (currentQuestions.length > 0) {
                    displayQuestion(currentIndex);
                    updateQuestionCounter();
                }
            } catch (error) {
                console.error('Error loading questions:', error);
            }
        }

        // Display current question
        function displayQuestion(index) {
            const question = currentQuestions[index];
            const options = JSON.parse(question.options);
            
            let html = `
                <h3 class="text-lg font-semibold mb-4">${index + 1}. ${question.question}</h3>
                <div class="space-y-3">
            `;
            
            options.forEach((option, i) => {
                html += `
                    <div class="flex items-center p-3 border rounded hover:bg-gray-50 cursor-pointer option-item ${selectedAnswer === i ? 'bg-blue-100 border-blue-500' : ''}" data-index="${i}">
                        <input type="radio" name="answer" value="${i}" class="ml-3" ${selectedAnswer === i ? 'checked' : ''}>
                        <span>${option}</span>
                    </div>
                `;
            });
            
            html += '</div>';
            
            document.getElementById('question-container').innerHTML = html;
            
            // Add click event to options
            document.querySelectorAll('.option-item').forEach(item => {
                item.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    selectAnswer(index);
                });
            });
        }

        // Select answer
        function selectAnswer(index) {
            if (isAnswered) return;
            selectedAnswer = index;
            displayQuestion(currentIndex);
        }

        // Update question counter
        function updateQuestionCounter() {
            document.getElementById('question-counter').textContent = 
                `${currentIndex + 1} / ${currentQuestions.length}`;
        }

        // Submit answer
        async function submitAnswer() {
            if (selectedAnswer === null) {
                alert('الرجاء اختيار إجابة');
                return;
            }

            if (isAnswered) return;

            const question = currentQuestions[currentIndex];
            
            try {
                const response = await fetch(`${API_BASE}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questionId: question.id,
                        selectedIndex: selectedAnswer
                    })
                });
                
                const result = await response.json();
                
                let resultHtml = '';
                if (result.correct) {
                    resultHtml = `
                        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                            <p class="font-bold">✅ إجابة صحيحة!</p>
                            <p class="mt-2">${result.explanation || ''}</p>
                        </div>
                    `;
                } else {
                    const options = JSON.parse(question.options);
                    resultHtml = `
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                            <p class="font-bold">❌ إجابة خاطئة</p>
                            <p class="mt-2">الإجابة الصحيحة: ${options[result.correctIndex]}</p>
                            <p class="mt-2">${result.explanation || ''}</p>
                        </div>
                    `;
                }
                
                document.getElementById('result-container').innerHTML = resultHtml;
                document.getElementById('result-container').classList.remove('hidden');
                isAnswered = true;
                
            } catch (error) {
                console.error('Error submitting answer:', error);
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const stats = await response.json();
                
                // Global stats
                const totalAttempts = stats.global.total_correct + stats.global.total_wrong;
                const globalHtml = `
                    <div class="bg-blue-50 p-4 rounded">
                        <div class="text-2xl font-bold text-blue-800">${stats.global.total_questions}</div>
                        <div class="text-sm text-gray-600">إجمالي الأسئلة</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded">
                        <div class="text-2xl font-bold text-green-800">${stats.global.total_correct || 0}</div>
                        <div class="text-sm text-gray-600">إجابات صحيحة</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded">
                        <div class="text-2xl font-bold text-red-800">${stats.global.total_wrong || 0}</div>
                        <div class="text-sm text-gray-600">إجابات خاطئة</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded">
                        <div class="text-2xl font-bold text-purple-800">${stats.global.avg_success_rate ? stats.global.avg_success_rate.toFixed(1) : 0}%</div>
                        <div class="text-sm text-gray-600">نسبة النجاح</div>
                    </div>
                `;
                document.getElementById('global-stats').innerHTML = globalHtml;
                
                // Questions stats
                let questionsHtml = '';
                stats.questions.forEach(q => {
                    const total = q.correct_count + q.wrong_count;
                    questionsHtml += `
                        <div class="border rounded p-4">
                            <div class="font-medium mb-2">${q.question}</div>
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                <div class="text-green-600">✓ ${q.correct_count || 0}</div>
                                <div class="text-red-600">✗ ${q.wrong_count || 0}</div>
                                <div class="text-blue-600">${q.success_rate || 0}%</div>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('questions-stats').innerHTML = questionsHtml;
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Admin functions
        async function adminLogin() {
            const password = document.getElementById('admin-password').value;
            if (!password) return;
            
            adminToken = password;
            await loadAdminQuestions();
            document.getElementById('admin-login').classList.add('hidden');
            document.getElementById('admin-content').classList.remove('hidden');
        }

        async function loadAdminQuestions() {
            try {
                const response = await fetch(`${API_BASE}/questions`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const questions = await response.json();
                
                let html = '';
                questions.forEach(q => {
                    const options = JSON.parse(q.options);
                    html += `
                        <div class="border rounded p-4">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="font-medium mb-2">${q.question}</div>
                                    <div class="text-sm text-gray-600 mb-2">
                                        ${options.map((opt, i) => 
                                            `<span class="${i === q.correctIndex ? 'text-green-600 font-bold' : ''}">${opt}</span>${i < 3 ? ' | ' : ''}`
                                        ).join('')}
                                    </div>
                                    <div class="text-sm text-gray-500">${q.explanation || ''}</div>
                                </div>
                                <div class="flex gap-2 mr-4">
                                    <button onclick="editQuestion(${q.id})" class="text-blue-600 hover:text-blue-800">تعديل</button>
                                    <button onclick="deleteQuestion(${q.id})" class="text-red-600 hover:text-red-800">حذف</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('questions-list').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading admin questions:', error);
            }
        }

        function showAddForm() {
            document.getElementById('question-id').value = '';
            document.getElementById('question-text').value = '';
            document.getElementById('correct-index').value = '';
            document.getElementById('explanation').value = '';
            
            // Generate 4 option inputs
            let optionsHtml = '';
            for (let i = 0; i < 4; i++) {
                optionsHtml += `
                    <input type="text" id="option-${i}" placeholder="الخيار ${i + 1}" class="w-full p-2 border rounded mb-2">
                `;
            }
            document.getElementById('options-container').innerHTML = optionsHtml;
            
            document.getElementById('question-form').classList.remove('hidden');
        }

        async function editQuestion(id) {
            try {
                const response = await fetch(`${API_BASE}/questions/${id}`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const q = await response.json();
                const options = JSON.parse(q.options);
                
                document.getElementById('question-id').value = q.id;
                document.getElementById('question-text').value = q.question;
                document.getElementById('correct-index').value = q.correctIndex;
                document.getElementById('explanation').value = q.explanation || '';
                
                let optionsHtml = '';
                for (let i = 0; i < 4; i++) {
                    optionsHtml += `
                        <input type="text" id="option-${i}" value="${options[i] || ''}" placeholder="الخيار ${i + 1}" class="w-full p-2 border rounded mb-2">
                    `;
                }
                document.getElementById('options-container').innerHTML = optionsHtml;
                
                document.getElementById('question-form').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading question:', error);
            }
        }

        async function saveQuestion() {
            const id = document.getElementById('question-id').value;
            const question = document.getElementById('question-text').value;
            const correctIndex = parseInt(document.getElementById('correct-index').value);
            const explanation = document.getElementById('explanation').value;
            
            const options = [];
            for (let i = 0; i < 4; i++) {
                options.push(document.getElementById(`option-${i}`).value);
            }
            
            if (!question || options.some(opt => !opt) || isNaN(correctIndex)) {
                alert('الرجاء ملء جميع الحقول');
                return;
            }
            
            const data = { question, options, correctIndex, explanation };
            
            try {
                const url = id ? `${API_BASE}/questions/${id}` : `${API_BASE}/questions`;
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    document.getElementById('question-form').classList.add('hidden');
                    await loadAdminQuestions();
                    await loadQuestions();
                }
                
            } catch (error) {
                console.error('Error saving question:', error);
            }
        }

        async function deleteQuestion(id) {
            if (!confirm('هل أنت متأكد من حذف هذا السؤال؟')) return;
            
            try {
                await fetch(`${API_BASE}/questions/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                await loadAdminQuestions();
                await loadQuestions();
                
            } catch (error) {
                console.error('Error deleting question:', error);
            }
        }

        // Tab switching
        document.getElementById('tab-quiz').addEventListener('click', () => {
            document.getElementById('quiz-section').classList.remove('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('stats-section').classList.add('hidden');
            
            document.getElementById('tab-quiz').className = 'px-6 py-3 font-medium text-blue-600 border-b-2 border-blue-600';
            document.getElementById('tab-admin').className = 'px-6 py-3 font-medium text-gray-500 hover:text-blue-600';
            document.getElementById('tab-stats').className = 'px-6 py-3 font-medium text-gray-500 hover:text-blue-600';
        });

        document.getElementById('tab-admin').addEventListener('click', () => {
            document.getElementById('quiz-section').classList.add('hidden');
            document.getElementById('admin-section').classList.remove('hidden');
            document.getElementById('stats-section').classList.add('hidden');
            
            document.getElementById('tab-quiz').className = 'px-6 py-3 font-medium text-gray-500 hover:text-blue-600';
            document.getElementById('tab-admin').className = 'px-6 py-3 font-medium text-blue-600 border-b-2 border-blue-600';
            document.getElementById('tab-stats').className = 'px-6 py-3 font-medium text-gray-500 hover:text-blue-600';
        });

        document.getElementById('tab-stats').addEventListener('click', () => {
            document.getElementById('quiz-section').classList.add('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('stats-section').classList.remove('hidden');
            
            document.getElementById('tab-quiz').className = 'px-6 py-3 font-medium text-gray-500 hover:text-blue-600';
            document.getElementById('tab-admin').className = 'px-6 py-3 font-medium text-gray-500 hover:text-blue-600';
            document.getElementById('tab-stats').className = 'px-6 py-3 font-medium text-blue-600 border-b-2 border-blue-600';
            
            loadStats();
        });

        // Event listeners
        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                selectedAnswer = null;
                isAnswered = false;
                document.getElementById('result-container').classList.add('hidden');
                displayQuestion(currentIndex);
                updateQuestionCounter();
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentIndex < currentQuestions.length - 1) {
                currentIndex++;
                selectedAnswer = null;
                isAnswered = false;
                document.getElementById('result-container').classList.add('hidden');
                displayQuestion(currentIndex);
                updateQuestionCounter();
            }
        });

        document.getElementById('submit-answer').addEventListener('click', submitAnswer);
        
        document.getElementById('admin-login-btn').addEventListener('click', adminLogin);
        document.getElementById('show-add-form').addEventListener('click', showAddForm);
        document.getElementById('save-question').addEventListener('click', saveQuestion);
        document.getElementById('cancel-form').addEventListener('click', () => {
            document.getElementById('question-form').classList.add('hidden');
        });

        // Initialize
        loadQuestions();

        // Make functions global for onclick handlers
        window.editQuestion = editQuestion;
        window.deleteQuestion = deleteQuestion;
    </script>
</body>
</html>
