<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Quiz - Examen √âdition</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Tajawal', sans-serif;
            font-size: 1.3rem;
        }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* Mask animation for admin/stats sections */
        .mask-reveal {
            animation: maskReveal 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes maskReveal {
            0% { 
                opacity: 0;
                transform: scale(0.95);
                filter: blur(10px);
            }
            100% { 
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
            }
        }
        
        /* Secret admin trigger - completely hidden but interactive */
        .secret-trigger {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: transparent;
            cursor: pointer;
            z-index: 9999;
            opacity: 0.05;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .secret-trigger:hover {
            opacity: 0.3;
            background: rgba(0,0,0,0.1);
        }
        
        /* Statistics cards hover effect */
        .stat-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #0d9488;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Admin password modal */
        .admin-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .admin-modal.active {
            display: flex;
        }
        
        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 10001;
            overflow-y: auto;
            display: none;
        }
        
        .admin-panel.active {
            display: block;
        }
        
        .stats-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 10001;
            overflow-y: auto;
            display: none;
        }
        
        .stats-panel.active {
            display: block;
        }
        
        /* Close button for panels */
        .close-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 10002;
            font-size: 24px;
            border: none;
            transition: all 0.3s;
        }
        .close-panel:hover {
            transform: rotate(90deg);
            background: #ef4444;
            color: white;
        }
        
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #134e4a; border-radius: 5px; }
        
        /* Full-line Question Grid - Mobile Responsive */
        .question-grid-container {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            padding: 10px 0;
            margin: 10px 0;
            white-space: nowrap;
            scroll-behavior: smooth;
        }
        
        .question-grid {
            display: inline-flex;
            gap: 8px;
            padding: 0 4px;
            min-width: min-content;
        }
        
        .question-grid-item {
            width: 45px;
            height: 45px;
            min-width: 45px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Tablet size */
        @media (min-width: 768px) {
            .question-grid-item {
                width: 50px;
                height: 50px;
                min-width: 50px;
                font-size: 1.1rem;
            }
        }
        
        /* Desktop size */
        @media (min-width: 1024px) {
            .question-grid-item {
                width: 55px;
                height: 55px;
                min-width: 55px;
                font-size: 1.2rem;
            }
        }
        
        .question-grid-item.correct {
            background: #10b981;
            color: white;
            border: 2px solid #059669;
        }
        
        .question-grid-item.wrong {
            background: #ef4444;
            color: white;
            border: 2px solid #dc2626;
        }
        
        .question-grid-item.current {
            border: 3px solid #0d9488;
            transform: scale(1.1);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.3);
            background: #ffffff;
            color: #0d9488;
            font-weight: 900;
        }
        
        .question-grid-item.current.correct {
            background: #10b981;
            color: white;
            border: 3px solid #fbbf24;
        }
        
        .question-grid-item.current.wrong {
            background: #ef4444;
            color: white;
            border: 3px solid #fbbf24;
        }
        
        .question-grid-item:hover:not(.current) {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* Scroll buttons for desktop */
        .scroll-btn {
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            color: #134e4a;
            font-size: 1.2rem;
        }
        
        .scroll-btn:hover {
            background: #134e4a;
            color: white;
            transform: scale(1.1);
        }
        
        .scroll-btn:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 768px) {
            .scroll-btn {
                display: none;
            }
        }
        
        /* Improved option cards for mobile */
        .option-btn {
            width: 100%;
            text-align: left;
            padding: 1.5rem;
            border-radius: 2rem;
            border: 4px solid #f1f5f9;
            background: #f8fafc;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 1rem;
            min-height: 120px;
        }
        
        @media (min-width: 768px) {
            .option-btn {
                padding: 3rem;
                border-radius: 3.5rem;
                gap: 3rem;
                min-height: 200px;
            }
        }
        
        .option-btn:hover:not(:disabled) {
            background: white;
            border-color: #0d9488;
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        
        .option-letter {
            width: 50px;
            height: 50px;
            min-width: 50px;
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 900;
            color: #94a3b8;
            transition: all 0.3s;
        }
        
        @media (min-width: 768px) {
            .option-letter {
                width: 96px;
                height: 96px;
                min-width: 96px;
                font-size: 3rem;
                border-width: 4px;
            }
        }
        
        .option-btn:hover .option-letter {
            color: #0d9488;
            border-color: #0d9488;
        }
        
        /* Responsive text sizes */
        .question-text {
            font-size: 1.8rem;
            line-height: 1.3;
        }
        
        @media (min-width: 768px) {
            .question-text {
                font-size: 3.5rem;
            }
        }
        
        @media (min-width: 1024px) {
            .question-text {
                font-size: 4.5rem;
            }
        }
        
        .option-text {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        @media (min-width: 768px) {
            .option-text {
                font-size: 2rem;
            }
        }
        
        @media (min-width: 1024px) {
            .option-text {
                font-size: 2.5rem;
            }
        }
        
        /* Responsive container padding */
        .container-padding {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }
        
        @media (min-width: 640px) {
            .container-padding {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
        }
        
        @media (min-width: 1024px) {
            .container-padding {
                padding-left: 2rem;
                padding-right: 2rem;
            }
        }
        
        /* Touch-friendly navigation */
        .nav-button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
        }
        
        @media (min-width: 768px) {
            .nav-button {
                padding: 1rem 2rem;
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

    <!-- Secret Admin Trigger (invisible button) -->
    <div class="secret-trigger" id="secretTrigger" title="üîê Zone R√©serv√©e">
        <i class="fa-solid fa-key"></i>
    </div>

    <!-- Admin Password Modal -->
    <div class="admin-modal" id="adminModal">
        <div class="bg-white rounded-[3rem] p-8 md:p-16 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-20 h-20 md:w-24 md:h-24 bg-teal-900 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fa-solid fa-lock text-white text-3xl md:text-4xl"></i>
                </div>
                <h2 class="text-3xl md:text-4xl font-black text-teal-950 mb-2">Acc√®s Professeur</h2>
                <p class="text-lg md:text-xl text-slate-500">Veuillez entrer le code d'acc√®s</p>
            </div>
            
            <input type="password" id="adminPassword" 
                   class="w-full p-4 md:p-6 text-xl md:text-2xl border-4 border-slate-200 rounded-2xl mb-6 text-center font-bold"
                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            
            <div class="flex flex-col md:flex-row gap-4">
                <button onclick="closeAdminModal()" 
                        class="flex-1 py-4 md:py-6 text-xl md:text-2xl bg-slate-200 rounded-2xl font-bold hover:bg-slate-300">
                    Annuler
                </button>
                <button onclick="verifyAdminPassword()" 
                        class="flex-1 py-4 md:py-6 text-xl md:text-2xl bg-teal-900 text-white rounded-2xl font-bold hover:bg-teal-800">
                    Acc√©der
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Panel (Hidden by default) -->
    <div class="admin-panel" id="adminPanel">
        <button class="close-panel" onclick="closeAllPanels()">
            <i class="fa-solid fa-times"></i>
        </button>
        
        <div class="container mx-auto p-4 md:p-8 max-w-6xl">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-10">
                <h1 class="text-3xl md:text-5xl font-black text-teal-950">
                    <i class="fa-solid fa-sliders mr-4 text-teal-600"></i>
                    Panneau d'Administration
                </h1>
                <span class="text-lg md:text-xl bg-teal-100 px-4 md:px-6 py-2 md:py-3 rounded-full font-bold text-teal-800">
                    Mode Professeur
                </span>
            </div>
            
            <!-- Admin Login Status -->
            <div id="adminLoginSection" class="mb-10">
                <div class="bg-slate-100 p-6 md:p-8 rounded-[2rem]">
                    <h2 class="text-2xl md:text-3xl font-bold mb-4">Authentification Requise</h2>
                    <p class="text-lg md:text-xl mb-4">Entrez le mot de passe administrateur pour g√©rer les questions</p>
                    <div class="flex flex-col md:flex-row gap-4">
                        <input type="password" id="adminMasterPassword" 
                               class="flex-1 p-4 text-lg md:text-xl border-2 rounded-xl"
                               placeholder="Mot de passe administrateur">
                        <button onclick="adminLogin()" 
                                class="px-6 md:px-8 py-4 bg-teal-900 text-white rounded-xl font-bold hover:bg-teal-800 text-lg md:text-xl">
                            <i class="fa-solid fa-sign-in-alt mr-2"></i>
                            Connexion
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Admin Content (Hidden until logged in) -->
            <div id="adminContent" class="hidden">
                <!-- Add Question Button -->
                <div class="mb-8">
                    <button onclick="showAddQuestionForm()" 
                            class="w-full md:w-auto bg-green-600 text-white px-6 md:px-8 py-4 rounded-xl text-xl md:text-2xl font-bold hover:bg-green-700 transition">
                        <i class="fa-solid fa-plus mr-3"></i>
                        Ajouter une Question
                    </button>
                </div>
                
                <!-- Question Form (Hidden by default) -->
                <div id="questionForm" class="hidden bg-white p-6 md:p-8 rounded-[2rem] shadow-xl mb-8 border-4 border-teal-100">
                    <h3 class="text-2xl md:text-3xl font-bold mb-6">Nouvelle Question</h3>
                    <input type="hidden" id="editQuestionId">
                    
                    <div class="mb-6">
                        <label class="block text-lg md:text-xl font-bold mb-2">Question</label>
                        <textarea id="questionText" rows="3" 
                                  class="w-full p-4 text-lg md:text-xl border-2 rounded-xl"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
                        <div>
                            <label class="block text-lg md:text-xl font-bold mb-2">Option A</label>
                            <input type="text" id="option0" class="w-full p-4 text-lg md:text-xl border-2 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-lg md:text-xl font-bold mb-2">Option B</label>
                            <input type="text" id="option1" class="w-full p-4 text-lg md:text-xl border-2 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-lg md:text-xl font-bold mb-2">Option C</label>
                            <input type="text" id="option2" class="w-full p-4 text-lg md:text-xl border-2 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-lg md:text-xl font-bold mb-2">Option D</label>
                            <input type="text" id="option3" class="w-full p-4 text-lg md:text-xl border-2 rounded-xl">
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-lg md:text-xl font-bold mb-2">Index de la r√©ponse correcte (0-3)</label>
                        <input type="number" id="correctIndex" min="0" max="3" 
                               class="w-full p-4 text-lg md:text-xl border-2 rounded-xl">
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-lg md:text-xl font-bold mb-2">Explication</label>
                        <textarea id="explanationText" rows="3" 
                                  class="w-full p-4 text-lg md:text-xl border-2 rounded-xl"></textarea>
                    </div>
                    
                    <div class="flex flex-col md:flex-row gap-4">
                        <button onclick="saveQuestion()" 
                                class="px-6 md:px-8 py-4 bg-green-600 text-white rounded-xl text-lg md:text-2xl font-bold hover:bg-green-700">
                            <i class="fa-solid fa-save mr-2"></i>
                            Enregistrer
                        </button>
                        <button onclick="cancelQuestionForm()" 
                                class="px-6 md:px-8 py-4 bg-slate-500 text-white rounded-xl text-lg md:text-2xl font-bold hover:bg-slate-600">
                            Annuler
                        </button>
                    </div>
                </div>
                
                <!-- Questions List -->
                <div id="questionsList" class="space-y-4">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Panel (Hidden by default) -->
    <div class="stats-panel" id="statsPanel">
        <button class="close-panel" onclick="closeAllPanels()">
            <i class="fa-solid fa-times"></i>
        </button>
        
        <div class="container mx-auto p-4 md:p-8 max-w-6xl">
            <h1 class="text-3xl md:text-5xl font-black text-teal-950 mb-8 md:mb-10">
                <i class="fa-solid fa-chart-pie mr-4 text-teal-600"></i>
                Statistiques D√©taill√©es
            </h1>
            
            <!-- Global Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6 mb-8 md:mb-10" id="globalStatsCards">
                <!-- Populated by JS -->
            </div>
            
            <!-- Questions Stats -->
            <h2 class="text-2xl md:text-3xl font-bold mb-4 md:mb-6">Performance par Question</h2>
            <div class="space-y-3 md:space-y-4" id="questionsStatsList">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Main Quiz Interface -->
    <nav class="bg-teal-950 text-white p-4 md:p-10 shadow-2xl border-b-4 border-teal-500">
        <div class="container mx-auto flex justify-between items-center px-2 md:px-10">
            <span class="font-black text-xl md:text-5xl tracking-tight uppercase italic flex items-center">
                <i class="fa-solid fa-microscope mr-2 md:mr-5 text-teal-400 text-xl md:text-4xl"></i> 
                <span class="hidden xs:inline">Examen Leishmaniose</span>
                <span class="inline xs:hidden">Examen</span>
            </span>
            <div class="flex gap-2 md:gap-4">
                <button onclick="openStatsPanel()" class="opacity-40 hover:opacity-100 transition-all hover:scale-110 text-xl md:text-4xl p-2" title="Voir les statistiques">
                    <i class="fa-solid fa-chart-simple"></i>
                </button>
                <button onclick="openAdminModal()" class="opacity-40 hover:opacity-100 transition-all hover:scale-110 text-xl md:text-4xl p-2" title="Acc√®s Professeur">
                    <i class="fa-solid fa-sliders"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Full-Line Navigation Rapide -->
    <div class="bg-white shadow-md py-3 md:py-4 border-b border-slate-200 sticky top-0 z-40">
        <div class="container-padding mx-auto">
            <div class="flex items-center gap-2">
                <div class="hidden md:flex items-center gap-2 flex-shrink-0">
                    <i class="fa-solid fa-grid text-teal-600 text-xl"></i>
                    <span class="text-lg font-bold whitespace-nowrap">Navigation rapide:</span>
                </div>
                
                <!-- Left scroll button (desktop only) -->
                <button class="scroll-btn hidden md:flex" onclick="scrollGrid('left')">
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
                
                <!-- Scrollable question grid -->
                <div class="question-grid-container" id="questionGridContainer">
                    <div id="questionGrid" class="question-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Right scroll button (desktop only) -->
                <button class="scroll-btn hidden md:flex" onclick="scrollGrid('right')">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                
                <!-- Mobile indicator -->
                <div class="md:hidden flex-shrink-0 text-sm text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
                    <i class="fa-solid fa-hand-pointer mr-1"></i>
                    Faites d√©filer
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-3 md:p-6 max-w-[98%] md:max-w-[96%] mt-4 md:mt-8">
        
        <div id="progressSection" class="mb-6 md:mb-14 px-2 md:px-8">
            <div class="flex flex-col md:flex-row justify-between text-lg md:text-2xl font-bold text-teal-950 mb-3 md:mb-5 tracking-wide gap-2">
                <span id="qNumber">Question 01 / 25</span>
                <span class="font-medium opacity-60 italic text-sm md:text-base">Progression Acad√©mique</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-4 md:h-8 p-1 shadow-inner border border-slate-300">
                <div id="progressBar" class="bg-gradient-to-r from-teal-600 to-teal-400 h-full rounded-full transition-all duration-1000 ease-out shadow-lg" style="width: 0%"></div>
            </div>
        </div>

        <div id="quizCard" class="bg-white rounded-[2rem] md:rounded-[5rem] shadow-[0_50px_100px_-20px_rgba(0,0,0,0.15)] overflow-hidden border border-slate-100">
            <div class="p-4 md:p-16 lg:p-28">
                
                <div class="text-center mb-8 md:mb-24">
                    <h2 id="qText" class="question-text font-black text-slate-900 leading-[1.2] mb-4 md:mb-6">
                        Chargement de l'examen...
                    </h2>
                    <div class="w-16 md:w-32 h-2 md:h-3 bg-teal-500 mx-auto rounded-full"></div>
                </div>
                
                <div id="optionsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-10 lg:gap-14">
                </div>

                <button id="nextBtn" class="hidden mt-8 md:mt-24 w-full bg-teal-900 text-white font-black text-xl md:text-4xl py-6 md:py-12 rounded-[2rem] md:rounded-[3.5rem] hover:bg-black shadow-2xl transition-all transform active:scale-95 flex items-center justify-center gap-3 md:gap-6">
                    CONTINUER L'EXAMEN <i class="fa-solid fa-arrow-right-long text-lg md:text-2xl"></i>
                </button>
            </div>
        </div>

        <div id="endScreen" class="hidden text-center p-6 md:p-32 bg-white rounded-[2rem] md:rounded-[5rem] shadow-2xl mt-8 md:mt-12 fade-in">
            <div class="text-8xl md:text-[15rem] mb-6 md:mb-12 drop-shadow-2xl">üéì</div>
            <h2 class="text-4xl md:text-8xl font-black mb-4 md:mb-8 text-teal-950">Examen Termin√©</h2>
            <p class="text-lg md:text-3xl text-slate-500 mb-4 md:mb-8 font-medium">Vos r√©sultats ont √©t√© enregistr√©s avec succ√®s.</p>
            
            <div class="bg-teal-50 inline-block px-8 md:px-24 py-6 md:py-12 rounded-[2rem] md:rounded-[4rem] border-4 md:border-[6px] border-teal-200 mb-8 md:mb-16 shadow-inner">
                <h3 class="text-2xl md:text-4xl text-teal-800 font-bold mb-2 md:mb-4">Votre Score Final</h3>
                <p id="finalScoreDisplay" class="text-4xl md:text-8xl font-black text-teal-600">0 / 0</p>
            </div>

            <div>
                <button onclick="location.reload()" class="bg-teal-900 text-white px-8 md:px-28 py-4 md:py-10 rounded-full font-black text-2xl md:text-5xl hover:bg-teal-700 transition-all shadow-2xl uppercase tracking-tighter">
                    Relancer l'Examen
                </button>
            </div>
        </div>
    </div>

    <!-- Secret Trigger Indicator (optional) -->
    <div class="fixed bottom-4 left-4 text-xs text-slate-400 opacity-30">
        üîê
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const API_BASE = 'https://pevqcm-api.ferhathamza17.workers.dev/api';
        const ADMIN_PASSWORD = 'admin123'; // Change this in production!
        
        // ==================== STATE MANAGEMENT ====================
        let questions = [];
        let currentIdx = 0;
        let answered = false;
        let userScore = 0;
        let userAnswers = [];
        let adminToken = null;
        let questionStatus = {}; // Track correct/wrong per question
        let adminLoggedIn = false;

        // ==================== UI ELEMENTS ====================
        const ui = {
            qText: document.getElementById('qText'),
            qNumber: document.getElementById('qNumber'),
            options: document.getElementById('optionsContainer'),
            nextBtn: document.getElementById('nextBtn'),
            progressBar: document.getElementById('progressBar'),
            card: document.getElementById('quizCard'),
            end: document.getElementById('endScreen'),
            progressSection: document.getElementById('progressSection'),
            questionGrid: document.getElementById('questionGrid'),
            gridContainer: document.getElementById('questionGridContainer')
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadQuestions();
            
            // Secret trigger click (bottom left invisible button)
            document.getElementById('secretTrigger').addEventListener('click', () => {
                // Secret sequence: click 3 times quickly
                if(window.secretClickCount === undefined) window.secretClickCount = 0;
                window.secretClickCount++;
                
                if(window.secretClickCount >= 3) {
                    openAdminModal();
                    window.secretClickCount = 0;
                }
                
                // Reset after 2 seconds
                clearTimeout(window.secretTimer);
                window.secretTimer = setTimeout(() => {
                    window.secretClickCount = 0;
                }, 2000);
            });
        });

        // ==================== SCROLL FUNCTION FOR GRID ====================
        function scrollGrid(direction) {
            const container = ui.gridContainer;
            if (container) {
                const scrollAmount = 200;
                if (direction === 'left') {
                    container.scrollLeft -= scrollAmount;
                } else {
                    container.scrollLeft += scrollAmount;
                }
            }
        }

        // ==================== API FUNCTIONS ====================
        async function loadQuestions() {
            try {
                const response = await fetch(`${API_BASE}/questions`);
                questions = await response.json();
                
                // Initialize question status
                questions.forEach(q => {
                    questionStatus[q.id] = 'unanswered';
                });
                
                render();
                updateQuestionGrid();
            } catch (error) {
                console.error('Error loading questions:', error);
                ui.qText.textContent = 'Erreur de chargement des questions';
            }
        }

        // ==================== QUIZ FUNCTIONS ====================
        function render() {
            if(currentIdx >= questions.length) {
                finishQuiz();
                return;
            }

            answered = false;
            const q = questions[currentIdx];
            ui.qText.textContent = q.question;
            ui.qNumber.textContent = `Question ${String(currentIdx + 1).padStart(2, '0')} / ${questions.length}`;
            ui.progressBar.style.width = `${((currentIdx) / questions.length) * 100}%`;
            ui.nextBtn.classList.add('hidden');
            ui.options.innerHTML = '';

            const options = JSON.parse(q.options);
            
            options.forEach((opt, i) => {
                const wrapper = document.createElement('div');
                wrapper.className = "flex flex-col h-full fade-in";
                
                const btn = document.createElement('button');
                btn.className = "option-btn";
                btn.innerHTML = `
                    <span class="option-letter">${String.fromCharCode(65+i)}</span>
                    <span class="option-text text-slate-800 font-extrabold leading-tight flex-1">${opt}</span>
                `;
                
                btn.onclick = () => validate(i, wrapper, btn, q);
                wrapper.appendChild(btn);
                ui.options.appendChild(wrapper);
            });
            
            updateQuestionGrid();
            
            // Scroll the current question into view in the grid
            setTimeout(() => {
                const currentElement = document.querySelector(`.question-grid-item[data-index="${currentIdx}"]`);
                if (currentElement && ui.gridContainer) {
                    currentElement.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }, 100);
        }

        async function validate(choice, container, btn, q) {
            if(answered) return;
            answered = true;

            const isCorrect = choice === q.correctIndex;
            
            if(isCorrect) userScore++;
            userAnswers.push({ qIndex: currentIdx, isCorrect: isCorrect });
            
            // Update question status
            questionStatus[q.id] = isCorrect ? 'correct' : 'wrong';

            const buttons = ui.options.querySelectorAll('button');

            buttons.forEach((b, idx) => {
                const badge = b.querySelector('.option-letter');
                if(idx === q.correctIndex) {
                    b.classList.add('border-green-500', 'bg-green-50');
                    b.classList.remove('border-slate-50', 'bg-slate-50');
                    badge.classList.add('text-green-600', 'border-green-500');
                    badge.classList.remove('text-slate-300', 'border-slate-200');
                } else if(idx === choice && !isCorrect) {
                    b.classList.add('border-red-500', 'bg-red-50');
                    b.classList.remove('border-slate-50', 'bg-slate-50');
                    badge.classList.add('text-red-600', 'border-red-500');
                    badge.classList.remove('text-slate-300', 'border-slate-200');
                }
                b.disabled = true;
            });

            // Submit answer to server
            try {
                await fetch(`${API_BASE}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questionId: q.id,
                        selectedIndex: choice
                    })
                });
            } catch (error) {
                console.error('Error submitting answer:', error);
            }

            const feedback = document.createElement('div');
            feedback.className = `mt-6 md:mt-20 p-6 md:p-20 rounded-[2rem] md:rounded-[4rem] text-xl md:text-5xl fade-in ${isCorrect ? 'bg-green-100 text-green-950 border-green-600' : 'bg-slate-900 text-teal-100 border-teal-500'} border-l-8 md:border-l-[30px] font-bold shadow-3xl col-span-full`;
            feedback.innerHTML = `
                <div class="flex items-center gap-4 md:gap-8 mb-4 md:mb-6">
                    <div class="w-12 h-12 md:w-20 md:h-20 rounded-full ${isCorrect ? 'bg-green-600' : 'bg-teal-500'} flex items-center justify-center text-white flex-shrink-0">
                        <i class="fa-solid ${isCorrect ? 'fa-check' : 'fa-info'} text-xl md:text-4xl"></i>
                    </div>
                    <span class="tracking-widest uppercase text-lg md:text-3xl">${isCorrect ? 'Excellente Analyse' : 'Correction M√©dicale'}</span>
                </div>
                <p class="text-lg md:text-3xl lg:text-5xl font-medium leading-[1.4]">${q.explanation}</p>
            `;
            
            ui.options.appendChild(feedback);
            ui.nextBtn.classList.remove('hidden');
            
            setTimeout(() => {
                feedback.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 250);
            
            updateQuestionGrid();
        }

        function finishQuiz() {
            ui.card.classList.add('hidden');
            ui.progressSection.classList.add('hidden');
            ui.end.classList.remove('hidden');
            document.getElementById('finalScoreDisplay').textContent = `${userScore} / ${questions.length}`;
            
            // Send final results
            fetch('/api/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    score: userScore,
                    total: questions.length,
                    answers: userAnswers
                })
            });
        }

        // ==================== NAVIGATION ====================
        ui.nextBtn.onclick = () => {
            currentIdx++;
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        function goToQuestion(index) {
            if (index >= 0 && index < questions.length) {
                currentIdx = index;
                answered = false;
                render();
            }
        }

        // ==================== QUESTION GRID ====================
        function updateQuestionGrid() {
            if (!ui.questionGrid || questions.length === 0) return;
            
            let gridHtml = '';
            questions.forEach((q, idx) => {
                const status = questionStatus[q.id] || 'unanswered';
                let classNames = 'question-grid-item';
                
                if (status === 'correct') classNames += ' correct';
                if (status === 'wrong') classNames += ' wrong';
                if (idx === currentIdx) classNames += ' current';
                
                gridHtml += `
                    <div data-index="${idx}" onclick="goToQuestion(${idx})" 
                         class="${classNames}">
                        ${idx + 1}
                    </div>
                `;
            });
            ui.questionGrid.innerHTML = gridHtml;
        }

        // ==================== PANEL FUNCTIONS ====================
        function openAdminModal() {
            document.getElementById('adminModal').classList.add('active');
        }

        function closeAdminModal() {
            document.getElementById('adminModal').classList.remove('active');
            document.getElementById('adminPassword').value = '';
        }

        function openAdminPanel() {
            document.getElementById('adminPanel').classList.add('active');
            document.body.style.overflow = 'hidden';
            loadAdminQuestions();
        }

        function openStatsPanel() {
            document.getElementById('statsPanel').classList.add('active');
            document.body.style.overflow = 'hidden';
            loadStatistics();
        }

        function closeAllPanels() {
            document.getElementById('adminModal').classList.remove('active');
            document.getElementById('adminPanel').classList.remove('active');
            document.getElementById('statsPanel').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // ==================== ADMIN FUNCTIONS ====================
        function verifyAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                closeAdminModal();
                openAdminPanel();
            } else {
                alert('Mot de passe incorrect');
            }
        }

        function adminLogin() {
            const password = document.getElementById('adminMasterPassword').value;
            if (password === ADMIN_PASSWORD) {
                adminLoggedIn = true;
                document.getElementById('adminLoginSection').classList.add('hidden');
                document.getElementById('adminContent').classList.remove('hidden');
                loadAdminQuestions();
            } else {
                alert('Mot de passe incorrect');
            }
        }

        async function loadAdminQuestions() {
            if (!adminLoggedIn) return;
            
            try {
                const response = await fetch(`${API_BASE}/questions`, {
                    headers: { 'Authorization': `Bearer ${ADMIN_PASSWORD}` }
                });
                const data = await response.json();
                
                let html = '';
                data.forEach(q => {
                    const options = JSON.parse(q.options);
                    html += `
                        <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg border-2 border-slate-200">
                            <div class="flex flex-col md:flex-row justify-between items-start gap-4">
                                <div class="flex-1">
                                    <p class="text-xl md:text-2xl font-bold mb-4">${q.question}</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 mb-4">
                                        ${options.map((opt, i) => `
                                            <div class="${i === q.correctIndex ? 'bg-green-100 border-green-500' : 'bg-slate-100'} p-3 rounded-xl border-2">
                                                <span class="font-bold mr-2">${String.fromCharCode(65+i)}:</span>
                                                <span class="text-sm md:text-base">${opt}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <p class="text-sm md:text-base text-slate-600 italic">${q.explanation || ''}</p>
                                </div>
                                <div class="flex gap-2 self-end md:self-start">
                                    <button onclick="editQuestion(${q.id})" 
                                            class="px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 text-sm md:text-base">
                                        <i class="fa-solid fa-edit"></i>
                                    </button>
                                    <button onclick="deleteQuestion(${q.id})" 
                                            class="px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 text-sm md:text-base">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('questionsList').innerHTML = html;
            } catch (error) {
                console.error('Error loading admin questions:', error);
            }
        }

        function showAddQuestionForm() {
            document.getElementById('editQuestionId').value = '';
            document.getElementById('questionText').value = '';
            document.getElementById('option0').value = '';
            document.getElementById('option1').value = '';
            document.getElementById('option2').value = '';
            document.getElementById('option3').value = '';
            document.getElementById('correctIndex').value = '';
            document.getElementById('explanationText').value = '';
            document.getElementById('questionForm').classList.remove('hidden');
        }

        function cancelQuestionForm() {
            document.getElementById('questionForm').classList.add('hidden');
        }

        async function saveQuestion() {
            const id = document.getElementById('editQuestionId').value;
            const question = document.getElementById('questionText').value;
            const options = [
                document.getElementById('option0').value,
                document.getElementById('option1').value,
                document.getElementById('option2').value,
                document.getElementById('option3').value
            ];
            const correctIndex = parseInt(document.getElementById('correctIndex').value);
            const explanation = document.getElementById('explanationText').value;

            if (!question || options.some(opt => !opt) || isNaN(correctIndex)) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            const data = { question, options, correctIndex, explanation };

            try {
                const url = id ? `${API_BASE}/questions/${id}` : `${API_BASE}/questions`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ADMIN_PASSWORD}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    cancelQuestionForm();
                    loadAdminQuestions();
                    loadQuestions(); // Reload main questions
                }
            } catch (error) {
                console.error('Error saving question:', error);
            }
        }

        async function editQuestion(id) {
            try {
                const response = await fetch(`${API_BASE}/questions/${id}`, {
                    headers: { 'Authorization': `Bearer ${ADMIN_PASSWORD}` }
                });
                const q = await response.json();
                const options = JSON.parse(q.options);

                document.getElementById('editQuestionId').value = q.id;
                document.getElementById('questionText').value = q.question;
                document.getElementById('option0').value = options[0] || '';
                document.getElementById('option1').value = options[1] || '';
                document.getElementById('option2').value = options[2] || '';
                document.getElementById('option3').value = options[3] || '';
                document.getElementById('correctIndex').value = q.correctIndex;
                document.getElementById('explanationText').value = q.explanation || '';
                
                document.getElementById('questionForm').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading question:', error);
            }
        }

        async function deleteQuestion(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette question ?')) return;

            try {
                await fetch(`${API_BASE}/questions/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${ADMIN_PASSWORD}` }
                });
                loadAdminQuestions();
                loadQuestions();
            } catch (error) {
                console.error('Error deleting question:', error);
            }
        }

        // ==================== STATISTICS FUNCTIONS ====================
        async function loadStatistics() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const stats = await response.json();
                
                // Global stats cards
                const globalHtml = `
                    <div class="stat-card bg-gradient-to-br from-teal-500 to-teal-700 text-white p-3 md:p-6 rounded-xl md:rounded-2xl shadow-xl">
                        <i class="fa-solid fa-question-circle text-xl md:text-4xl mb-2 md:mb-4 opacity-80"></i>
                        <p class="text-sm md:text-2xl font-bold mb-1 md:mb-2">Total Questions</p>
                        <p class="text-xl md:text-5xl font-black">${stats.global.total_questions || 0}</p>
                    </div>
                    <div class="stat-card bg-gradient-to-br from-green-500 to-green-700 text-white p-3 md:p-6 rounded-xl md:rounded-2xl shadow-xl">
                        <i class="fa-solid fa-check-circle text-xl md:text-4xl mb-2 md:mb-4 opacity-80"></i>
                        <p class="text-sm md:text-2xl font-bold mb-1 md:mb-2">R√©ponses Correctes</p>
                        <p class="text-xl md:text-5xl font-black">${stats.global.total_correct || 0}</p>
                    </div>
                    <div class="stat-card bg-gradient-to-br from-red-500 to-red-700 text-white p-3 md:p-6 rounded-xl md:rounded-2xl shadow-xl">
                        <i class="fa-solid fa-times-circle text-xl md:text-4xl mb-2 md:mb-4 opacity-80"></i>
                        <p class="text-sm md:text-2xl font-bold mb-1 md:mb-2">R√©ponses Incorrectes</p>
                        <p class="text-xl md:text-5xl font-black">${stats.global.total_wrong || 0}</p>
                    </div>
                    <div class="stat-card bg-gradient-to-br from-purple-500 to-purple-700 text-white p-3 md:p-6 rounded-xl md:rounded-2xl shadow-xl">
                        <i class="fa-solid fa-chart-line text-xl md:text-4xl mb-2 md:mb-4 opacity-80"></i>
                        <p class="text-sm md:text-2xl font-bold mb-1 md:mb-2">Taux de R√©ussite</p>
                        <p class="text-xl md:text-5xl font-black">${stats.global.avg_success_rate ? stats.global.avg_success_rate.toFixed(1) : 0}%</p>
                    </div>
                `;
                document.getElementById('globalStatsCards').innerHTML = globalHtml;
                
                // Questions stats
                let questionsHtml = '';
                stats.questions.forEach((q, idx) => {
                    const total = q.correct_count + q.wrong_count;
                    questionsHtml += `
                        <div class="bg-white p-4 md:p-6 rounded-xl md:rounded-2xl shadow-lg border-2 border-slate-200">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-3 md:mb-4">
                                <p class="text-base md:text-xl font-bold">Question ${idx + 1}</p>
                                <span class="px-3 md:px-4 py-1 md:py-2 bg-${q.success_rate > 50 ? 'green' : 'red'}-100 rounded-full text-xs md:text-sm font-bold">
                                    ${q.success_rate || 0}% de r√©ussite
                                </span>
                            </div>
                            <p class="text-sm md:text-lg mb-3 md:mb-4">${q.question}</p>
                            <div class="flex flex-wrap gap-3 md:gap-8 text-sm md:text-xl">
                                <span class="text-green-600"><i class="fa-solid fa-check mr-1 md:mr-2"></i>${q.correct_count || 0} correctes</span>
                                <span class="text-red-600"><i class="fa-solid fa-times mr-1 md:mr-2"></i>${q.wrong_count || 0} incorrectes</span>
                                <span class="text-blue-600"><i class="fa-solid fa-users mr-1 md:mr-2"></i>${total} total</span>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('questionsStatsList').innerHTML = questionsHtml;
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // ==================== EXPOSE GLOBALLY ====================
        window.goToQuestion = goToQuestion;
        window.openAdminModal = openAdminModal;
        window.closeAdminModal = closeAdminModal;
        window.verifyAdminPassword = verifyAdminPassword;
        window.openAdminPanel = openAdminPanel;
        window.openStatsPanel = openStatsPanel;
        window.closeAllPanels = closeAllPanels;
        window.adminLogin = adminLogin;
        window.showAddQuestionForm = showAddQuestionForm;
        window.cancelQuestionForm = cancelQuestionForm;
        window.saveQuestion = saveQuestion;
        window.editQuestion = editQuestion;
        window.deleteQuestion = deleteQuestion;
        window.scrollGrid = scrollGrid;
    </script>
</body>
</html>
